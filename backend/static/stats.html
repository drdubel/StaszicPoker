<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Poker Leaderboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 2rem;
            background: #f0f2f5;
        }

        h1 {
            text-align: center;
        }

        input {
            margin-bottom: 1rem;
            padding: 0.5rem;
            width: 100%;
            max-width: 300px;
            font-size: 1rem;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        table {
            border-collapse: collapse;
            margin: auto;
            width: 90%;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        th,
        td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #333;
            color: white;
            cursor: pointer;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        .center {
            text-align: center;
        }
    </style>
</head>

<body>
    <h1>Poker Leaderboard</h1>
    <input type="text" id="searchInput" placeholder="Filter by player name..." />

    <table id="leaderboard">
        <thead>
            <tr>
                <th onclick="sortTable(0)">Player</th>
                <th onclick="sortTable(1)">Wins</th>
                <th onclick="sortTable(2)">Losses</th>
                <th onclick="sortTable(3)">Earnings ($)</th>
            </tr>
        </thead>
        <tbody id="leaderboard-body">
            <!-- Filled dynamically -->
        </tbody>
    </table>

    <script>
        const leaderboardBody = document.getElementById("leaderboard-body");

        // Filtering logic
        document.getElementById("searchInput").addEventListener("keyup", function () {
            const filter = this.value.toLowerCase();
            const rows = leaderboardBody.querySelectorAll("tr");
            rows.forEach(row => {
                const player = row.cells[0].textContent.toLowerCase();
                row.style.display = player.includes(filter) ? "" : "none";
            });
        });

        let sortDirection = true;

        function sortTable(columnIndex) {
            const rows = Array.from(leaderboardBody.rows);

            rows.sort((a, b) => {
                const valA = a.cells[columnIndex].textContent;
                const valB = b.cells[columnIndex].textContent;

                const numA = parseFloat(valA);
                const numB = parseFloat(valB);

                if (!isNaN(numA) && !isNaN(numB)) {
                    return sortDirection ? numA - numB : numB - numA;
                } else {
                    return sortDirection
                        ? valA.localeCompare(valB)
                        : valB.localeCompare(valA);
                }
            });

            sortDirection = !sortDirection;
            rows.forEach(row => leaderboardBody.appendChild(row));
        }

        // WebSocket logic
        function getCookies() {
            var cookies = document.cookie.split(';')
            var cookieDict = {}
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].split('=')
                cookieDict[cookie[0].trim()] = cookie[1]
            }
            return cookieDict
        }

        function loadLeaderboard(dataArray) {
            const tbody = document.getElementById("leaderboard-body");
            tbody.innerHTML = ""; // Clear previous rows

            dataArray.forEach(([userid, wins, losses, earnings]) => {
                const row = document.createElement("tr");
                row.innerHTML = `
      <td>${userid}</td>
      <td>${wins}</td>
      <td>${losses}</td>
      <td>${earnings}</td>
    `;
                tbody.appendChild(row);
            });
        }



        wsId = getCookies()['wsId']

        var ws = new WebSocket("ws://127.0.0.1:8000/ws/read/" + wsId)
        ws.onopen = function () {
            console.log("WebSocket connection established.");
        };

        ws.onmessage = function (event) {
            let data = JSON.parse(JSON.parse(event.data));
            console.log("Received data:", data);

            loadLeaderboard(data);
        };

        ws.onopen = () => console.log("WebSocket connection opened.");
        ws.onerror = (e) => console.error("WebSocket error:", e);
        ws.onclose = () => console.log("WebSocket closed.");
    </script>
</body>

</html>